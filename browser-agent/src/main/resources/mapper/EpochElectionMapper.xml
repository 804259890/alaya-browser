<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platon.browser.persistence.dao.mapper.EpochBusinessMapper">
<update id="election" parameterType="com.platon.browser.common.complement.param.epoch.Election">
	create temporary table tmp(`id` varchar(130)) ENGINE = MEMORY;
	insert into tmp(`id`) select `node_id` from staking where `status` = 1 and `node_id` in <foreach open="(" collection="preValidatorList" item="item"  separator="," close=")"> #{item} </foreach> and `pre_cons_block_qty` = 0;

	update `staking` set
	`staking_hes` = 0,
	`staking_locked` = 0,
	`staking_reduction` = `staking_locked`,
	`staking_reduction_epoch` = #{settingEpoch},
	`status` = if(`staking_locked` > 0, 2, 3),
	`is_consensus` = 2,
	`is_settle` = 2,
	`leave_time` = #{time}
	where
	`status` = 1
	and
	`node_id` in <foreach open="(" collection="preValidatorList" item="item"  separator="," close=")"> #{item} </foreach>
	and
	`pre_cons_block_qty` = 0;

	update `node` set
	`staking_hes` = 0,
	`staking_locked` = 0,
	`staking_reduction` = `staking_locked`,
	`staking_reduction_epoch` = #{settingEpoch},
	`status` = if(`staking_locked` > 0, 2, 3),
	`is_consensus` = 2,
	`is_settle` = 2,
	`leave_time` = #{time},
	`stat_slash_low_qty` = `stat_slash_low_qty` + 1 ,
	`total_value` = `total_value` - `staking_hes` - `staking_locked`
	where
	`node_id` in (select `id` from tmp);

	INSERT INTO `node_opt`
	(`node_id`,`type`,`b_num`,`time`,`desc`)
	SELECT
		`id` ,
		7 AS `type`,
		#{bNum} AS `b_num`,
		#{time} AS `time`,
		'0|6|100000|1' AS `desc`
	FROM
		tmp;

	DROP TABLE tmp;

</update>
</mapper>