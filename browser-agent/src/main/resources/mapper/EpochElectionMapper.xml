<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platon.browser.complement.dao.mapper.EpochBusinessMapper">

<select id="querySlashNode" resultType="java.lang.String">
	select 
		`node_id`
	from staking
	where `status` = 1
		and `node_id` in <foreach open="(" collection="list" item="item"  separator="," close=")"> #{item} </foreach>
		and `pre_cons_block_qty` = 0;
</select>

<update id="slashNode" parameterType="com.platon.browser.complement.dao.param.epoch.Election">
	update `staking` set
		`staking_reduction` = `staking_locked`,
		`staking_reduction_epoch` = #{settingEpoch},
		`status` = if(`staking_locked` > 0, 2, 3),
		`staking_hes` = 0,
		`staking_locked` = 0,
		`is_consensus` = 2,
		`is_settle` = 2,
		`leave_time` = #{time}
	where `status` = 1
		and `node_id` in <foreach open="(" collection="slashNodeList" item="item"  separator="," close=")"> #{item} </foreach>;

	update `node` set
		`staking_reduction` = `staking_locked`,
		`staking_reduction_epoch` = #{settingEpoch},
		`status` = if(`staking_locked` > 0, 2, 3),
		`staking_hes` = 0,
		`staking_locked` = 0,
		`is_consensus` = 2,
		`is_settle` = 2,
		`leave_time` = #{time},
		`stat_slash_low_qty` = `stat_slash_low_qty` + 1 ,
		`total_value` = 0
	where `node_id` in  <foreach open="(" collection="slashNodeList" item="item"  separator="," close=")"> #{item} </foreach>;
</update>
</mapper>