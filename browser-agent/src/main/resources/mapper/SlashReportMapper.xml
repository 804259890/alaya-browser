<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.platon.browser.complement.dao.mapper.SlashBusinessMapper">
<update id="report" parameterType="com.platon.browser.complement.dao.param.slash.Report">
	/*1、更新委托*/
	update `delegation` set
		`delegate_released` = `delegate_hes` + `delegate_locked`,
		`delegate_hes` = 0,
		`delegate_locked` = 0
	where `node_id` = #{nodeId}
	and `staking_block_num` = #{stakingBlockNum}
	and `is_history` = 2;
	/*2、更新节点*/
	update `node` set
		`leave_time` = #{time},
		`status` =  #{codeStatus},
		`staking_reduction_epoch` = #{codeStakingReductionEpoch},
		`staking_reduction` = #{codeCurStakingLocked},
		`total_value` = 0,
		`staking_locked` = 0,
		`staking_hes` = 0,
		`stat_delegate_released` = `stat_delegate_released` + `stat_delegate_value`,
		`stat_delegate_value` = 0,
		`stat_valid_addrs` = 0,
		`stat_invalid_addrs` = (select count(distinct delegate_addr) from delegation where node_id = #{nodeId} and is_history = 2),
		`stat_slash_multi_qty` = `stat_slash_multi_qty` +1,
		`is_consensus` = 2,
		`is_settle` = 2
	where `node_id` = #{nodeId};
	/*3、更新质押*/
	update `staking` set
		`leave_time` = #{time},
		`status` =  #{codeStatus},
		`staking_reduction_epoch` = #{codeStakingReductionEpoch},
		`staking_reduction` = #{codeCurStakingLocked},
		`staking_locked` = 0,
		`staking_hes` = 0,
		`stat_delegate_released` = `stat_delegate_hes` + `stat_delegate_locked`,
		`stat_delegate_hes` = 0,
		`stat_delegate_locked` = 0,
		`is_consensus` = 2,
		`is_settle` = 2
	where `node_id` = #{nodeId}
	and `staking_block_num` = #{stakingBlockNum};
	/*4、添加处罚记录*/
	insert into `slash` (
		`hash`,
		`node_id`,
		`slash_rate`,
		`slash_value`,
		`reward`,
		`benefit_addr`,
		`data`,
		`is_quit`
	) values (
		#{txHash},
		#{nodeId},
		#{slashRate},
		#{codeSlashValue},
		#{codeRewardValue},
		#{benefitAddr},
		#{slashData},
		1
	);

</update>
</mapper>