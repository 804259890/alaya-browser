## 浏览器线上部署环境调整方案

### 1、当前状态说明
当前浏览器应用（数据采集进程browser-agent、对外接口服务进程browser-api）及其相关服务（Mysql、Redis集群）同处同一台机器，共用同一个磁盘，其部署图如下：
![image](doc/1.浏览器部署图-old.png)
由于数据采集端会频繁访问Mysql和Redis集群进行数据的写入，导致它们之间对磁盘I/O资源的争夺，进而引起Redis集群和Mysql数据库访问超时问题。

### 2、优化方案说明
基于上述问题分析，现计划申请一台性能较好的机器（下图中【机器3】），把Mysql和Redis安装在这台机器上，最终的部署图如下：
![image](doc/1.浏览器部署图-new.png)

### 3、环境平稳切换步骤说明
为保证旧环境服务可继续对外提供服务，以及新环境的数据完整性，【机器3】中Mysql和Redis的数据不从【机器1】中的Mysql和Redis迁移，而是重新从链上采集，待【机器3】上的数据与链上同步后，再在【机器1】上配置启动新的browser-agent和browser-api进程连接至【机器3】的Mysql和Redis，待新的进程启动完成并验证没有问题后，把nginx指向新的browser-api进程，并停止【机器1】上旧的browser-api进程和browser-agent进程。
因此，整个环境升级总结如下：
##### 3.1、保留机器1的当前状态不要动，在新机器（下图【机器3】）安装Mysql和Redis，并在上面启动browser-agent进程从【机器2】上采集数据入库到【机器3】上的Mysql和Redis，此时的部署结构如下：
![image](doc/2.升级步骤1部署图.png)
##### 3.2、待机【器3上】的数据与链上同步后，再在【机器1】上配置启动新的browser-agent和browser-api进程连接至【机器3】的Mysql和Redis，待新的进程启动完成并验证没有问题后，把nginx指向新的browser-api进程，并停止【机器1】上旧的browser-api进程和browser-agent进程，最终的部署结构如下：
![image](doc/1.浏览器部署图-new.png)


### 4、恢复节点出块数
```
# 设置节点出块数量
update `node_ranking` nr set nr.`block_count`=(select count(*) from block bl where bl.`node_id` = nr.`node_id`) where nr.`is_valid`=1;
# 设置节点出的第一个块的块号
update `node_ranking` nr set nr.`begin_number`=(select bl.`number` from block bl where bl.`node_id` = nr.`node_id` order by bl.`number` asc limit 1) where nr.`is_valid`=1;
```

./configure --prefix=/opt/nginx --sbin-path=/opt/nginx/nginx --conf-path=/opt/nginx/nginx.conf --pid-path=/opt/nginx/nginx.pid
get browser:0.6.0:amigo:chain103:staticstics 
ZRANGE browser:0.6.0:amigo:chain103:blocks 0 999 WITHSCORES




redis-cli -c -h 192.168.9.191 -p 7001 keys "browser:0.6.1:testa:chain203*" > testa-keys.txt
for line in `cat testa-keys.txt`; do redis-cli -c -h 192.168.9.191 -p 7001 del $line; done;
